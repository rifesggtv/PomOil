<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PomOil - Tu lienzo para concentrarte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;700&family=Lato:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #fdf6f0;
            color: #2f2f2f;
        }
        .font-main-title { font-family: 'Merriweather', serif; }
        .font-artistic { font-family: 'Playfair Display', serif; }
        .bg-canvas { background-color: #fdf6f0; }
        .text-main { color: #2f2f2f; }
        .text-timer { color: #3b3b3b; }
        .btn-active { background-color: #9e683b; color: #fdf6f0; transition: background-color 0.3s ease; }
        .btn-active:hover { background-color: #c28f52; }
        .btn-control { background-color: #657153; color: #fdf6f0; transition: background-color 0.3s ease; }
        .btn-control:hover { background-color: #8aa073; }
        .input-style { border: 1px solid #9e683b; background-color: #fff; color: #3b3b3b; }
        .input-style::placeholder { color: #9e683b; opacity: 0.7; }
        .input-file-style {
            border: 2px dashed #9e683b;
            padding: 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .input-file-style:hover {
            background-color: #fbf3eb;
        }
        .timer-circle-bg { stroke: #e0d8d0; }
        .timer-circle-progress { stroke: #9e683b; stroke-linecap: round; transform-origin: 50% 50%; transform: rotate(-90deg); transition: stroke-dashoffset 1s linear; }
        .soft-shadow { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); }
        .artistic-border { border: 1px solid transparent; box-shadow: 0 0 0 1px #d1c5b8, 0 0 10px 2px rgba(158, 104, 59, 0.1); }
        .modal-backdrop { background-color: rgba(59, 59, 59, 0.7); }
        .modal-content { background-color: #fdf6f0; }
        .section-oil-effect { position: relative; padding: 2rem; border-radius: 12px; }
        .section-oil-effect::before, .section-oil-effect::after { content: ''; position: absolute; border-radius: 12px; opacity: 0.15; pointer-events: none; }
        .section-oil-effect::before { top: -5px; left: 2%; width: 96%; height: 15px; background: linear-gradient(to bottom, rgba(158, 104, 59, 0.3), transparent); filter: blur(3px); }
        .section-oil-effect::after { bottom: -5px; left: 2%; width: 96%; height: 15px; background: linear-gradient(to top, rgba(158, 104, 59, 0.3), transparent); filter: blur(3px); }
        
        .player-container iframe { 
            border-radius: 12px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            width: 100%;
            height: 100%;
        }
        .player-wrapper {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #f0f0f0; /* Placeholder background */
            border-radius: 12px;
        }
        .player-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }


        .temporary-message {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            text-align: center;
        }
        .message-error { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .message-success { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

        .ai-response-study {
            background-color: #eef2ff; 
            border-left: 4px solid #6366f1; 
            color: #3730a3;
        }
        .ai-response-creativity {
            background-color: #fff7ed; 
            border-left: 4px solid #f97316; 
            color: #9a3412;
        }
        .ai-mode-button.active {
            background-color: #9e683b; 
            color: #fdf6f0;
            font-weight: bold;
        }
         .ai-mode-button {
            background-color: #e0d8d0; 
            color: #3b3b3b; 
        }

        #uploadedImagePreview {
            max-height: 200px; 
            max-width: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
            border: 1px solid #d1c5b8;
        }
        #imageModal {
            z-index: 100; 
        }
        #enlargedImageView {
            max-height: 80vh;
            max-width: 80vw;
            object-fit: contain;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        #closeImageModalButton {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #closeImageModalButton:hover {
            background-color: rgba(0,0,0,0.7);
        }
    </style>
</head>
<body class="bg-canvas text-main min-h-screen flex flex-col items-center p-4 selection:bg-[#9e683b] selection:text-[#fdf6f0]">

    <header class="text-center mb-8 mt-8 md:mt-4">
        <h1 class="font-artistic text-4xl md:text-5xl text-timer font-bold">PomOil</h1>
        <p class="text-sm text-[#657153] mt-1">Tu lienzo para concentrarte.</p>
    </header>

    <main class="w-full max-w-xl mx-auto space-y-8">
        <section id="timerSection" class="bg-canvas p-6 rounded-xl soft-shadow artistic-border section-oil-effect">
            <div class="flex flex-col items-center">
                <div class="relative w-48 h-48 md:w-60 md:h-60 mb-6">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="timer-circle-bg" cx="50" cy="50" r="45" stroke-width="8" fill="none"></circle>
                        <circle id="timerProgress" class="timer-circle-progress" cx="50" cy="50" r="45" stroke-width="8" fill="none" stroke-dasharray="282.74" stroke-dashoffset="0"></circle>
                    </svg>
                    <div id="timeDisplay" class="absolute inset-0 flex items-center justify-center text-4xl md:text-5xl font-main-title text-timer font-bold">
                        25:00
                    </div>
                </div>
                <div class="flex space-x-3 mb-6">
                    <button id="startButton" class="btn-active px-6 py-2 rounded-lg font-semibold text-lg">Iniciar</button>
                    <button id="pauseButton" class="btn-control px-6 py-2 rounded-lg font-semibold text-lg hidden">Pausar</button>
                    <button id="resetButton" class="btn-control px-6 py-2 rounded-lg font-semibold text-lg">Reiniciar</button>
                </div>
                <div id="currentModeDisplay" class="text-sm text-[#657153] mb-4 h-5 text-center"></div>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 w-full">
                    <button id="settingsButton" class="btn-control w-full py-2 px-4 rounded-lg flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 .54 1.73l-.01.5a2 2 0 0 1-.54 1.73l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-.54-1.73l.01-.5a2 2 0 0 1 .54-1.73l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <span>Configurar</span>
                    </button>
                    <button id="musicToggleButton" class="btn-control w-full py-2 px-4 rounded-lg flex items-center justify-center space-x-2">
                        <svg id="musicIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                        <span id="musicToggleText">Activar M√∫sica</span>
                    </button>
                </div>
            </div>
        </section>

        <section id="imageReferenceSection" class="bg-canvas p-6 rounded-xl soft-shadow artistic-border section-oil-effect">
            <h2 class="font-artistic text-2xl text-timer mb-4 text-center">Tu Apoyo Visual üñºÔ∏è</h2>
            <label for="imageUploadInput" class="input-file-style block text-center text-[#657153] mb-4">
                Haz clic aqu√≠ para seleccionar una imagen
            </label>
            <input type="file" id="imageUploadInput" accept="image/*" class="hidden">

            <div id="imagePreviewContainer" class="text-center space-y-3">
                <img id="uploadedImagePreview" src="#" alt="Imagen de referencia cargada" class="hidden mx-auto">
                <p id="imageUploadPlaceholder" class="text-[#657153] italic">Sube una imagen para tenerla como referencia r√°pida.</p>
                <div id="imageControls" class="hidden space-x-2">
                    <button id="enlargeImageButton" class="btn-control px-4 py-1.5 rounded-lg text-sm">Ampliar Imagen</button>
                    <button id="removeImageButton" class="btn-control px-4 py-1.5 rounded-lg text-sm bg-red-700 hover:bg-red-800">Quitar Imagen</button>
                </div>
            </div>
        </section>

        <section id="soundtrackSection" class="bg-canvas p-6 rounded-xl soft-shadow artistic-border section-oil-effect">
            <h2 class="font-artistic text-2xl text-timer mb-4 text-center">Tu Banda Sonora üé∂</h2>
            <div class="space-y-3">
                <input type="text" id="playlistLinkInput" placeholder="Pega enlace de playlist (Spotify o YouTube)" class="w-full p-3 rounded-lg input-style focus:outline-none focus:ring-2 focus:ring-[#9e683b]">
                <button id="loadPlaylistButton" class="btn-active w-full py-2 px-4 rounded-lg font-semibold">Cargar Playlist</button>
                <div id="playlistMessagePlaceholder" class="h-6 mt-1"></div>
            </div>
            <div id="playerHost" class="mt-6 min-h-[80px] md:min-h-[300px] player-wrapper"> <p id="playerDefaultPlaceholder" class="text-center text-[#657153] italic absolute inset-0 flex items-center justify-center">Activa la m√∫sica y carga una playlist para empezar.</p>
                 </div>
        </section>


        <section id="aiSection" class="bg-canvas p-6 rounded-xl soft-shadow artistic-border section-oil-effect">
            <h2 class="font-artistic text-2xl text-timer mb-6 text-center">Sugerencias Inteligentes ‚ú®</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-[#657153] mb-1">Elige un modo:</label>
                <div class="flex space-x-2">
                    <button id="aiModeStudy" class="ai-mode-button flex-1 py-2 px-4 rounded-lg text-sm">Estudio üìò</button>
                    <button id="aiModeCreativity" class="ai-mode-button flex-1 py-2 px-4 rounded-lg text-sm">Creatividad üé®</button>
                </div>
            </div>

            <div>
                <label for="aiQuestionInput" class="block text-sm font-medium text-[#657153] mb-1">Escribe tu pregunta o idea:</label>
                <textarea id="aiQuestionInput" rows="3" placeholder="Ej: ¬øC√≥mo resuelvo esta ecuaci√≥n? o ¬øQu√© colores combinan con el azul?" class="w-full p-3 rounded-lg input-style focus:outline-none focus:ring-2 focus:ring-[#9e683b]"></textarea>
            </div>

            <button id="getAiSuggestionButton" class="btn-active w-full py-2.5 px-4 rounded-lg font-semibold mt-4">Obtener Sugerencia</button>

            <div id="aiResponseContainer" class="mt-6 p-4 rounded-lg min-h-[50px] hidden whitespace-pre-wrap">
                </div>
             <div id="aiLoadingIndicator" class="text-center text-[#657153] italic mt-4 hidden">Pensando... üß†</div>
        </section>
    </main>

    <div id="settingsModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content p-6 md:p-8 rounded-xl soft-shadow w-full max-w-md section-oil-effect">
            <h3 class="font-artistic text-2xl text-timer mb-6 text-center">Configuraci√≥n General</h3>
            <div class="space-y-4">
                <div>
                    <label for="workTimeInput" class="block text-sm font-medium text-[#657153] mb-1">Tiempo de Trabajo (minutos):</label>
                    <input type="number" id="workTimeInput" value="25" min="1" class="w-full p-2 rounded-lg input-style">
                </div>
                <div>
                    <label for="shortBreakInput" class="block text-sm font-medium text-[#657153] mb-1">Descanso Corto (minutos):</label>
                    <input type="number" id="shortBreakInput" value="5" min="1" class="w-full p-2 rounded-lg input-style">
                </div>
                <div>
                    <label for="longBreakInput" class="block text-sm font-medium text-[#657153] mb-1">Descanso Largo (minutos):</label>
                    <input type="number" id="longBreakInput" value="15" min="1" class="w-full p-2 rounded-lg input-style">
                </div>
                <div>
                    <label for="alarmSoundSelect" class="block text-sm font-medium text-[#657153] mb-1">Sonido de Alarma:</label>
                    <select id="alarmSoundSelect" class="w-full p-2 rounded-lg input-style">
                        <option value="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">Reloj Despertador</option>
                        <option value="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg">Reloj Digital</option>
                        <option value="https://actions.google.com/sounds/v1/notifications/bell.ogg">Campana</option>
                        <option value="https://actions.google.com/sounds/v1/notifications/harp_notification.ogg">Arpa Suave</option>
                    </select>
                </div>
            </div>
            <div id="settingsMessagePlaceholder" class="h-8 mt-3"></div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelSettingsButton" class="btn-control px-4 py-2 rounded-lg">Cancelar</button>
                <button id="saveSettingsButton" class="btn-active px-4 py-2 rounded-lg">Guardar</button>
            </div>
        </div>
    </div>

    <div id="sessionEndModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content p-6 md:p-8 rounded-xl soft-shadow w-full max-w-sm text-center section-oil-effect">
            <h3 id="sessionEndTitle" class="font-artistic text-2xl text-timer mb-4">¬°Sesi√≥n Terminada!</h3>
            <p id="sessionEndMessage" class="text-main mb-6">¬øListo para la siguiente fase?</p>
            <button id="proceedNextPhaseButton" class="btn-active w-full py-2.5 px-4 rounded-lg font-semibold">Comenzar</button>
        </div>
    </div>

    <div id="imageModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden">
        <div class="relative">
            <img id="enlargedImageView" src="#" alt="Imagen de referencia ampliada">
            <button id="closeImageModalButton" title="Cerrar imagen">√ó</button>
        </div>
    </div>
    
    <audio id="notificationSound" preload="auto"></audio>

    <script>
        // --- DOM Elements ---
        const timeDisplay = document.getElementById('timeDisplay');
        const timerProgress = document.getElementById('timerProgress');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const resetButton = document.getElementById('resetButton');
        const settingsButton = document.getElementById('settingsButton');
        const currentModeDisplay = document.getElementById('currentModeDisplay');
        const notificationSound = document.getElementById('notificationSound');
        const musicToggleButton = document.getElementById('musicToggleButton');
        const musicToggleText = document.getElementById('musicToggleText');
        const musicIcon = document.getElementById('musicIcon');
        // Soundtrack Section
        const playlistLinkInput = document.getElementById('playlistLinkInput');
        const loadPlaylistButton = document.getElementById('loadPlaylistButton');
        const playerHost = document.getElementById('playerHost'); // Nuevo contenedor general
        const playerDefaultPlaceholder = document.getElementById('playerDefaultPlaceholder');
        const playlistMessagePlaceholder = document.getElementById('playlistMessagePlaceholder');
        // Settings Modal
        const settingsModal = document.getElementById('settingsModal');
        const workTimeInput = document.getElementById('workTimeInput');
        const shortBreakInput = document.getElementById('shortBreakInput');
        const longBreakInput = document.getElementById('longBreakInput');
        const alarmSoundSelect = document.getElementById('alarmSoundSelect');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const cancelSettingsButton = document.getElementById('cancelSettingsButton');
        const settingsMessagePlaceholder = document.getElementById('settingsMessagePlaceholder');
        // Session End Modal
        const sessionEndModal = document.getElementById('sessionEndModal');
        const sessionEndTitle = document.getElementById('sessionEndTitle');
        const sessionEndMessage = document.getElementById('sessionEndMessage');
        const proceedNextPhaseButton = document.getElementById('proceedNextPhaseButton');
        // AI Section
        const aiModeStudyButton = document.getElementById('aiModeStudy');
        const aiModeCreativityButton = document.getElementById('aiModeCreativity');
        const aiQuestionInput = document.getElementById('aiQuestionInput');
        const getAiSuggestionButton = document.getElementById('getAiSuggestionButton');
        const aiResponseContainer = document.getElementById('aiResponseContainer');
        const aiLoadingIndicator = document.getElementById('aiLoadingIndicator');
        // Image Reference Section
        const imageUploadInput = document.getElementById('imageUploadInput');
        const uploadedImagePreview = document.getElementById('uploadedImagePreview');
        const imageUploadPlaceholder = document.getElementById('imageUploadPlaceholder');
        const imageControls = document.getElementById('imageControls');
        const enlargeImageButton = document.getElementById('enlargeImageButton');
        const removeImageButton = document.getElementById('removeImageButton');
        const imageModal = document.getElementById('imageModal');
        const enlargedImageView = document.getElementById('enlargedImageView');
        const closeImageModalButton = document.getElementById('closeImageModalButton');

        // --- App State & Config ---
        let workTime = 25 * 60, shortBreakTime = 5 * 60, longBreakTime = 15 * 60;
        let selectedAlarmSound = 'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg';
        let currentTime = workTime, timerInterval, isPaused = false, currentMode = 'work', pomodoroCount = 0;
        let musicEnabled = false;
        let activePlayer = null; // 'spotify' o 'youtube'
        let activePlayerIframe = null; // Referencia al iframe del reproductor activo
        let currentAiMode = 'study';
        const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 45;

        // --- Utility Functions ---
        function showTemporaryMessage(element, message, type = 'error', duration = 3000) {
            element.textContent = message;
            element.className = `temporary-message message-${type}`; 
            setTimeout(() => { element.textContent = ''; element.className = ''; }, duration);
        }
        
        // --- Timer Logic ---
        function updateDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            let totalDuration = currentMode === 'work' ? workTime : (currentMode === 'shortBreak' ? shortBreakTime : longBreakTime);
            const progress = totalDuration > 0 ? ((totalDuration - currentTime) / totalDuration) * CIRCLE_CIRCUMFERENCE : 0;
            timerProgress.style.strokeDashoffset = progress;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            isPaused = false;
            startButton.classList.add('hidden');
            pauseButton.classList.remove('hidden');
            updateCurrentModeDisplay();
            if (musicEnabled && activePlayerIframe && currentMode === 'work') sendPlayerCommand('play');

            timerInterval = setInterval(() => {
                if (!isPaused && currentTime > 0) {
                    currentTime--;
                    updateDisplay();
                } else if (currentTime === 0) {
                    clearInterval(timerInterval);
                    handleSessionEnd();
                }
            }, 1000);
        }

        function pauseTimer() {
            isPaused = true;
            clearInterval(timerInterval);
            pauseButton.classList.add('hidden');
            startButton.classList.remove('hidden');
            startButton.textContent = 'Reanudar';
            if (musicEnabled && activePlayerIframe) sendPlayerCommand('pause');
        }

        function resetTimer(mode = 'work', manualReset = true) {
            clearInterval(timerInterval);
            isPaused = false;
            currentMode = mode;
            if (manualReset) pomodoroCount = 0;
            currentTime = mode === 'work' ? workTime : (mode === 'shortBreak' ? shortBreakTime : longBreakTime);
            updateDisplay();
            updateCurrentModeDisplay();
            startButton.classList.remove('hidden');
            pauseButton.classList.add('hidden');
            startButton.textContent = 'Iniciar';
            if (musicEnabled && activePlayerIframe) {
                 sendPlayerCommand(currentMode === 'work' ? 'play' : 'pause');
            }
        }
        
        function updateCurrentModeDisplay() {
            let modeText = '';
            switch(currentMode) {
                case 'work': modeText = 'Sesi√≥n de Trabajo'; break;
                case 'shortBreak': modeText = 'Descanso Corto'; break;
                case 'longBreak': modeText = 'Descanso Largo'; break;
            }
            currentModeDisplay.textContent = modeText;
        }

        function handleSessionEnd() {
            playNotificationSound();
            let title = '', message = '', buttonText = '';
            if (currentMode === 'work') {
                title = '¬°Trabajo Terminado!'; pomodoroCount++;
                message = pomodoroCount % 4 === 0 ? '¬°Excelente! Es hora de un merecido descanso largo.' : 'Buen trabajo. Toma un descanso corto.';
                buttonText = pomodoroCount % 4 === 0 ? 'Iniciar Descanso Largo' : 'Iniciar Descanso Corto';
            } else {
                title = currentMode === 'shortBreak' ? '¬°Descanso Corto Finalizado!' : '¬°Descanso Largo Finalizado!';
                message = '¬øListo para la siguiente fase?';
                buttonText = 'Iniciar Trabajo';
            }
            sessionEndTitle.textContent = title;
            sessionEndMessage.textContent = message;
            proceedNextPhaseButton.textContent = buttonText;
            sessionEndModal.classList.remove('hidden');
        }
        
        proceedNextPhaseButton.addEventListener('click', () => {
            sessionEndModal.classList.add('hidden');
            switchToNextMode();
        });

        function switchToNextMode() {
            if (currentMode === 'work') {
                currentMode = pomodoroCount % 4 === 0 ? 'longBreak' : 'shortBreak';
            } else { 
                currentMode = 'work';
            }
            resetTimer(currentMode, false); 
            startTimer(); 
        }

        function playNotificationSound() {
            notificationSound.src = selectedAlarmSound;
            notificationSound.currentTime = 0; 
            notificationSound.play().catch(error => console.warn("Error al reproducir sonido:", error));
        }

        // --- Settings Logic ---
        settingsButton.addEventListener('click', () => {
            workTimeInput.value = workTime / 60;
            shortBreakInput.value = shortBreakTime / 60;
            longBreakInput.value = longBreakTime / 60;
            alarmSoundSelect.value = selectedAlarmSound;
            settingsModal.classList.remove('hidden');
        });
        cancelSettingsButton.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            settingsMessagePlaceholder.textContent = ''; 
        });
        saveSettingsButton.addEventListener('click', () => {
            const newWorkTime = parseInt(workTimeInput.value), newShortBreak = parseInt(shortBreakInput.value), newLongBreak = parseInt(longBreakInput.value);
            if (newWorkTime > 0 && newShortBreak > 0 && newLongBreak > 0) {
                workTime = newWorkTime * 60; shortBreakTime = newShortBreak * 60; longBreakTime = newLongBreak * 60;
                selectedAlarmSound = alarmSoundSelect.value;
                settingsModal.classList.add('hidden');
                resetTimer(currentMode, false); 
                showTemporaryMessage(settingsMessagePlaceholder, 'Configuraci√≥n guardada.', 'success');
            } else {
                showTemporaryMessage(settingsMessagePlaceholder, 'Valores de tiempo no v√°lidos.', 'error');
            }
        });

        // --- Soundtrack Logic (Spotify & YouTube) ---
        musicToggleButton.addEventListener('click', () => {
            musicEnabled = !musicEnabled;
            musicToggleText.textContent = musicEnabled ? 'Desactivar M√∫sica' : 'Activar M√∫sica';
            if (musicEnabled) {
                musicIcon.innerHTML = `<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle><line x1="9" y1="8" x2="18" y2="6"></line>`;
                if (activePlayerIframe && currentMode === 'work' && !isPaused) sendPlayerCommand('play');
                playerDefaultPlaceholder.classList.toggle('hidden', !!activePlayerIframe);
            } else {
                musicIcon.innerHTML = `<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle><line x1="1" y1="1" x2="23" y2="23"></line>`;
                if (activePlayerIframe) sendPlayerCommand('pause');
                playerDefaultPlaceholder.classList.remove('hidden');
            }
        });

        loadPlaylistButton.addEventListener('click', () => {
            const link = playlistLinkInput.value.trim();
            if (!link) {
                showTemporaryMessage(playlistMessagePlaceholder, 'Por favor, pega un enlace de playlist.', 'error');
                return;
            }
            
            playerHost.innerHTML = ''; // Limpiar reproductor anterior
            playerDefaultPlaceholder.classList.add('hidden');
            activePlayerIframe = null;
            activePlayer = null;

            // Intenta detectar Spotify
            const spotifyRegex = /https?:\/\/open\.spotify\.com\/(playlist|track|album)\/([a-zA-Z0-9]+)/;
            const spotifyMatch = link.match(spotifyRegex);
            if (spotifyMatch && spotifyMatch[1] && spotifyMatch[2]) {
                const type = spotifyMatch[1];
                const id = spotifyMatch[2];
                const embedUrl = `https://open.spotify.com/embed/${type}/${id}`;
                loadSpotifyPlayer(embedUrl);
                playlistLinkInput.value = '';
                return;
            }

            // Intenta detectar YouTube Playlist
            const youtubePlaylistRegex = /(?:https?:\/\/)?(?:www\.)?youtube\.com\/playlist\?list=([a-zA-Z0-9_-]+)/;
            const youtubePlaylistMatch = link.match(youtubePlaylistRegex);
            if (youtubePlaylistMatch && youtubePlaylistMatch[1]) {
                const playlistId = youtubePlaylistMatch[1];
                const embedUrl = `https://www.youtube.com/embed/videoseries?list=${playlistId}&autoplay=1`; // Autoplay para YouTube
                loadYouTubePlayer(embedUrl);
                playlistLinkInput.value = '';
                return;
            }
            
            // Si no es ninguno de los dos
            showTemporaryMessage(playlistMessagePlaceholder, 'Enlace no reconocido (Spotify o YouTube Playlist).', 'error', 4000);
            playerDefaultPlaceholder.classList.remove('hidden');
        });

        function createPlayerIframe(src, allow) {
            const iframe = document.createElement('iframe');
            iframe.style.borderRadius = "12px";
            iframe.src = src;
            iframe.frameBorder = "0";
            iframe.allowFullscreen = true;
            iframe.allow = allow;
            iframe.loading = "lazy";
            playerHost.appendChild(iframe);
            return iframe;
        }

        function loadSpotifyPlayer(embedUrl) {
            activePlayerIframe = createPlayerIframe(embedUrl, "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture");
            activePlayer = 'spotify';
            activePlayerIframe.onload = () => {
                if (musicEnabled && currentMode === 'work' && !isPaused) sendPlayerCommand('play');
            };
            showTemporaryMessage(playlistMessagePlaceholder, 'Playlist de Spotify cargada.', 'success');
        }

        function loadYouTubePlayer(embedUrl) {
            activePlayerIframe = createPlayerIframe(embedUrl, "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share");
            activePlayer = 'youtube';
            // YouTube autoplay est√° en la URL, no necesita postMessage inicial si la m√∫sica est√° activa.
            // Si la m√∫sica no est√° activa, no deber√≠a sonar.
            if (!musicEnabled || (currentMode !== 'work' && !isPaused) ) {
                // Para evitar autoplay si no debe, podr√≠amos recargar el iframe sin autoplay o enviar 'pause'
                // Pero es m√°s complejo. Por ahora, el autoplay en la URL es m√°s simple.
            }
            showTemporaryMessage(playlistMessagePlaceholder, 'Playlist de YouTube cargada.', 'success');
        }
        
        function sendPlayerCommand(command) {
            if (!activePlayerIframe || !activePlayerIframe.contentWindow) return;
            
            let message;
            if (activePlayer === 'spotify') {
                message = JSON.stringify({ command: command }); // Spotify usa JSON string
                activePlayerIframe.contentWindow.postMessage(message, 'https://open.spotify.com/embed/');
            } else if (activePlayer === 'youtube') {
                // YouTube player API usa una estructura diferente para postMessage
                let func = command === 'play' ? 'playVideo' : (command === 'pause' ? 'pauseVideo' : null);
                if (func) {
                    message = JSON.stringify({
                        event: 'command',
                        func: func,
                        args: ''
                    });
                    activePlayerIframe.contentWindow.postMessage(message, 'https://www.youtube.com');
                }
            }
        }


        // --- AI Logic ---
        aiModeStudyButton.addEventListener('click', () => {
            currentAiMode = 'study';
            aiModeStudyButton.classList.add('active');
            aiModeCreativityButton.classList.remove('active');
            aiResponseContainer.className = 'mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap ai-response-study';
            if (!aiResponseContainer.classList.contains('hidden')) aiResponseContainer.classList.add('hidden'); 
        });
        aiModeCreativityButton.addEventListener('click', () => {
            currentAiMode = 'creativity';
            aiModeCreativityButton.classList.add('active');
            aiModeStudyButton.classList.remove('active');
            aiResponseContainer.className = 'mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap ai-response-creativity';
            if (!aiResponseContainer.classList.contains('hidden')) aiResponseContainer.classList.add('hidden');
        });
        getAiSuggestionButton.addEventListener('click', async () => {
            const question = aiQuestionInput.value.trim();
            if (!question) {
                aiResponseContainer.textContent = 'Por favor, escribe una pregunta o idea.';
                aiResponseContainer.className = `mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap message-error`;
                aiResponseContainer.classList.remove('hidden');
                return;
            }
            aiLoadingIndicator.classList.remove('hidden');
            aiResponseContainer.classList.add('hidden');
            getAiSuggestionButton.disabled = true;
            let prompt = currentAiMode === 'study' ? 
                `Eres un tutor acad√©mico experto y amigable. Ayuda al estudiante con la siguiente pregunta de manera clara, concisa y educativa. Si es un problema matem√°tico, muestra los pasos si es posible:\n\n"${question}"` :
                `Eres un asistente creativo, inspirador y entusiasta. Ofrece ideas originales y sugerencias √∫tiles para la siguiente petici√≥n o idea. Anima al usuario a explorar su creatividad:\n\n"${question}"`;
            try {
                const apiKey = "AIzaSyCSSfVuLqCyrQIRZqWGULr8BxoMmLLY4OY"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json(); throw new Error(`Error de la API: ${errorData.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    aiResponseContainer.textContent = result.candidates[0].content.parts[0].text;
                    aiResponseContainer.className = `mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap ${currentAiMode === 'study' ? 'ai-response-study' : 'ai-response-creativity'}`;
                } else {
                    aiResponseContainer.textContent = 'No se pudo obtener una respuesta con el formato esperado.';
                    aiResponseContainer.className = `mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap message-error`;
                }
            } catch (error) {
                console.error("Error al obtener sugerencia de IA:", error);
                aiResponseContainer.textContent = `Error: ${error.message}. Intenta de nuevo m√°s tarde.`;
                aiResponseContainer.className = `mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap message-error`;
            } finally {
                aiLoadingIndicator.classList.add('hidden');
                aiResponseContainer.classList.remove('hidden');
                getAiSuggestionButton.disabled = false;
            }
        });

        // --- Visual Reference Logic ---
        imageUploadInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImagePreview.src = e.target.result;
                    uploadedImagePreview.classList.remove('hidden');
                    imageUploadPlaceholder.classList.add('hidden');
                    imageControls.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                showTemporaryMessage(imageUploadPlaceholder.parentElement, "Por favor, selecciona un archivo de imagen.", 'error');
                removeUploadedImage();
            }
        });
        enlargeImageButton.addEventListener('click', function() {
            if (uploadedImagePreview.src && uploadedImagePreview.src !== '#') {
                enlargedImageView.src = uploadedImagePreview.src;
                imageModal.classList.remove('hidden');
            }
        });
        closeImageModalButton.addEventListener('click', function() {
            imageModal.classList.add('hidden');
            enlargedImageView.src = '#';
        });
        removeImageButton.addEventListener('click', removeUploadedImage);
        function removeUploadedImage() {
            uploadedImagePreview.src = '#';
            uploadedImagePreview.classList.add('hidden');
            imageUploadPlaceholder.classList.remove('hidden');
            imageControls.classList.add('hidden');
            imageUploadInput.value = null;
        }

        // --- App Initialization ---
        function initializeApp() {
            notificationSound.src = selectedAlarmSound; 
            timerProgress.style.strokeDasharray = CIRCLE_CIRCUMFERENCE;
            timerProgress.style.strokeDashoffset = 0; 
            updateDisplay();
            updateCurrentModeDisplay();
            aiModeStudyButton.click(); 
            // Asegurar que el playerHost est√© limpio al inicio y se vea el placeholder
            playerHost.innerHTML = ''; // Limpiar cualquier iframe persistente
            playerHost.appendChild(playerDefaultPlaceholder); // A√±adir el placeholder
            playerDefaultPlaceholder.classList.remove('hidden');

        }
        initializeApp();
    </script>
</body>
</html>
