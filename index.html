<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PomOil - Tu lienzo para concentrarte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;700&family=Lato:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #fdf6f0; 
            color: #2f2f2f;
        }
        .font-main-title { font-family: 'Merriweather', serif; }
        .font-artistic { font-family: 'Playfair Display', serif; }
        .bg-canvas { background-color: #fdf6f0; }
        .text-main { color: #2f2f2f; }
        .text-timer { color: #3b3b3b; }
        .btn-active { background-color: #9e683b; color: #fdf6f0; transition: background-color 0.3s ease; }
        .btn-active:hover { background-color: #c28f52; }
        .btn-control { background-color: #657153; color: #fdf6f0; transition: background-color 0.3s ease; }
        .btn-control:hover { background-color: #8aa073; }
        .input-style { border: 1px solid #9e683b; background-color: #fff; color: #3b3b3b; }
        .input-style::placeholder { color: #9e683b; opacity: 0.7; }
        
        .timer-circle-bg { stroke: #e0d8d0; }
        .timer-circle-progress { stroke: #9e683b; stroke-linecap: round; transform-origin: 50% 50%; transform: rotate(-90deg); transition: stroke-dashoffset 1s linear; }
        .soft-shadow { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); }
        .artistic-border { border: 1px solid transparent; box-shadow: 0 0 0 1px #d1c5b8, 0 0 10px 2px rgba(158, 104, 59, 0.1); }
        .modal-backdrop { background-color: rgba(59, 59, 59, 0.7); }
        .modal-content { background-color: #fdf6f0; }
        .section-oil-effect { position: relative; padding: 2rem; border-radius: 12px; }
        .section-oil-effect::before, .section-oil-effect::after { content: ''; position: absolute; border-radius: 12px; opacity: 0.15; pointer-events: none; }
        .section-oil-effect::before { top: -5px; left: 2%; width: 96%; height: 15px; background: linear-gradient(to bottom, rgba(158, 104, 59, 0.3), transparent); filter: blur(3px); }
        .section-oil-effect::after { bottom: -5px; left: 2%; width: 96%; height: 15px; background: linear-gradient(to top, rgba(158, 104, 59, 0.3), transparent); filter: blur(3px); }
        
        .player-wrapper { 
            position: relative; 
            height: 80px; 
            overflow: hidden;
            max-width: 100%;
            border-radius: 12px;
             background: #f0f0f0; 
        }
        .player-wrapper iframe {
            width: 100%;
            height: 100%;
            border-radius: 12px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .temporary-message { padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; margin-top: 0.5rem; text-align: center; }
        .message-error { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .message-success { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

        .ai-response-study { background-color: #eef2ff; border-left: 4px solid #6366f1; color: #3730a3; }
        .ai-response-creativity { background-color: #fff7ed; border-left: 4px solid #f97316; color: #9a3412; }
        .ai-mode-button.active { background-color: #9e683b; color: #fdf6f0; font-weight: bold; }
        .ai-mode-button { background-color: #e0d8d0; color: #3b3b3b; }

        #imageUploadDropArea {
            border: 2px dashed #9e683b; padding: 1.5rem; border-radius: 0.75rem; text-align: center;
            cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; background-color: #fbf3eb; 
        }
        #imageUploadDropArea.dragover { background-color: #f5e9dd; border-color: #c28f52; }
        #uploadedImagePreview { max-height: 200px; max-width: 100%; object-fit: contain; border-radius: 0.5rem; border: 1px solid #d1c5b8; }
        #imageModal { z-index: 100; }
        #enlargedImageView { max-height: 80vh; max-width: 80vw; object-fit: contain; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #closeImageModalButton { position: absolute; top: 1rem; right: 1rem; background-color: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; transition: background-color 0.2s ease; }
        #closeImageModalButton:hover { background-color: rgba(0,0,0,0.7); }

        #ambientAudioVisualizerCanvasVertical {
            width: 100%; height: 150px; background-color: #e0d8d0; border-radius: 8px;
            margin: 1rem auto 0 auto; border: 1px solid #c2b6a9;
        }
        #ambientAudioWarning { margin-top: 0.5rem; font-size: 0.8rem; color: #8c6f56; text-align: center; min-height: 1.2em; }
        .btn-visualizer-action { background-color: #8aa073; color: #fdf6f0; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-bottom: 0.5rem; transition: background-color 0.3s ease; }
        .btn-visualizer-action:hover { background-color: #657153; }
        #ambientAudioVisualizerSection .youtube-search-form { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center;}
        #ambientAudioVisualizerSection .youtube-search-input { padding: 0.6rem; font-size: 0.9rem; border-radius: 5px; border: 1px solid #9e683b; width: 200px; background-color: #fff;}
        #ambientAudioVisualizerSection .youtube-search-button { background: #9e683b; color: white; border: none; padding: 0.6rem 1rem; border-radius: 5px; cursor: pointer; font-size: 0.9rem;}

        #todoSection .todo-input-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        #todoSection #todoInput { flex-grow: 1; }
        #todoSection #addTodoButton { background-color: #657153; }
        #todoSection #todoList { list-style: none; padding: 0; }
        #todoSection .todo-item {
            display: flex; align-items: center; justify-content: space-between; padding: 0.75rem;
            background-color: #fbf3eb; border: 1px solid #e0d8d0; border-radius: 6px;
            margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s ease;
        }
        #todoSection .todo-item:hover { background-color: #f5e9dd; }
        #todoSection .todo-item.completed span { text-decoration: line-through; color: #8c6f56; }
        #todoSection .todo-item .delete-todo {
            background-color: transparent; border: none; color: #c28f52; 
            font-size: 1.2rem; cursor: pointer; padding: 0.25rem;
        }
        #todoSection .todo-item .delete-todo:hover { color: #9e683b; }

        .spotify-login-btn {
            background-color: #1DB954; /* Color oficial de Spotify */
            color: white;
            transition: background-color 0.3s ease;
        }
        .spotify-login-btn:hover {
            background-color: #1aa34a;
        }
        .page-footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            font-size: 0.8rem;
            color: #657153; /* Verde oliva */
        }

    </style>
</head>
<body class="bg-canvas text-main min-h-screen flex flex-col items-center p-4 selection:bg-[#9e683b] selection:text-[#fdf6f0]">

    <header class="text-center mb-6 mt-8 md:mt-4">
        <h1 class="font-artistic text-4xl md:text-5xl text-timer font-bold">PomOil</h1>
        <p class="text-sm text-[#657153] mt-1">Tu lienzo para concentrarte.</p>
        <p class="text-base text-main mt-3 max-w-md mx-auto">
            PomOil es tu compa√±ero ideal para el estudio y la creatividad, fusionando la t√©cnica Pomodoro con un ambiente art√≠stico y relajante. Organiza tus sesiones, mant√©n el foco y encuentra inspiraci√≥n, todo en un solo lugar.
        </p>
    </header>

    <main class="w-full max-w-xl mx-auto space-y-8">
        <section id="timerSection" class="bg-canvas p-6 rounded-xl soft-shadow artistic-border section-oil-effect">
            <div class="flex flex-col items-center">
                <div class="relative w-48 h-48 md:w-60 md:h-60 mb-6">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="timer-circle-bg" cx="50" cy="50" r="45" stroke-width="8" fill="none"></circle>
                        <circle id="timerProgress" class="timer-circle-progress" cx="50" cy="50" r="45" stroke-width="8" fill="none" stroke-dasharray="282.74" stroke-dashoffset="0"></circle>
                    </svg>
                    <div id="timeDisplay" class="absolute inset-0 flex items-center justify-center text-4xl md:text-5xl font-main-title text-timer font-bold">25:00</div>
                </div>
                <div class="flex space-x-3 mb-6">
                    <button id="startButton" class="btn-active px-6 py-2 rounded-lg font-semibold text-lg">Iniciar</button>
                    <button id="pauseButton" class="btn-control px-6 py-2 rounded-lg font-semibold text-lg hidden">Pausar</button>
                    <button id="resetButton" class="btn-control px-6 py-2 rounded-lg font-semibold text-lg">Reiniciar</button>
                </div>
                <div id="currentModeDisplay" class="text-sm text-[#657153] mb-4 h-5 text-center"></div>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 w-full">
                    <button id="settingsButton" class="btn-control w-full py-2 px-4 rounded-lg flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 .54 1.73l-.01.5a2 2 0 0 1-.54 1.73l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-.54-1.73l.01-.5a2 2 0 0 1 .54-1.73l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <span>Configurar</span>
                    </button>
                    <button id="musicToggleButton" class="btn-control w-full py-2 px-4 rounded-lg flex items-center justify-center space-x-2">
                        <svg id="musicIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                        <span id="musicToggleText">Activar M√∫sica</span>
                    </button>
                </div>
            </div>
        </section>

        <section id="imageReferenceSection" class="bg-canvas p-6 rounded-xl soft-shadow artistic-border section-oil-effect">
            <h2 class="font-artistic text-2xl text-timer mb-4 text-center">Tu Apoyo Visual üñºÔ∏è</h2>
            <div id="imageUploadDropArea" class="mb-4">
                <p class="text-[#657153] pointer-events-none">Arrastra una imagen aqu√≠ o <label for="imageUploadInput" class="text-[#9e683b] underline cursor-pointer hover:text-[#c28f52]">selecciona un archivo</label>.</p>
            </div>
            <input type="file" id="imageUploadInput" accept="image/*" class="hidden">
            <div id="imagePreviewContainer" class="text-center space-y-3">
                <img id="uploadedImagePreview" src="#" alt="Imagen de referencia cargada" class="hidden mx-auto">
                <p id="imageUploadPlaceholder" class="text-[#657153] italic">Sube una imagen para tenerla como referencia r√°pida.</p>
                <div id="imageControls" class="hidden space-x-2 mt-2">
                    <button id="enlargeImageButton" class="btn-control px-4 py-1.5 rounded-lg text-sm">Ampliar Imagen</button>
                    <button id="removeImageButton" class="btn-control px-4 py-1.5 rounded-lg text-sm bg-red-700 hover:bg-red-800">Quitar Imagen</button>
                </div>
            </div>
        </section>

        <section id="soundtrackSection" class="bg-canvas p-6 rounded-xl soft-shadow artistic-border section-oil-effect">
            <h2 class="font-artistic text-2xl text-timer mb-4 text-center">Tu Banda Sonora üé∂</h2>
            <div class="space-y-3">
                <input type="text" id="playlistLinkInput" placeholder="Pega enlace de Spotify (playlist, √°lbum, canci√≥n)" class="w-full p-3 rounded-lg input-style focus:outline-none focus:ring-2 focus:ring-[#9e683b]">
                <div class="flex space-x-2 mt-2">
                    <button id="loadPlaylistButton" class="btn-active w-2/3 py-2 px-4 rounded-lg font-semibold">Cargar M√∫sica</button>
                    <button id="spotifyLoginButton" class="spotify-login-btn w-1/3 py-2 px-4 rounded-lg font-semibold flex items-center justify-center space-x-1.5" title="Abre Spotify para iniciar sesi√≥n. Mejora la experiencia de reproducci√≥n (especialmente para usuarios Premium).">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm6.223 17.996c-.242.363-.726.484-1.089.242-3.024-1.814-6.808-2.241-11.226-1.21C5.544 17.107 5 16.744 5 16.38c0-.363.423-.726.786-.847 4.841-1.15 9.038-.666 12.484 1.394.363.242.484.726.242 1.089v-.01zm1.029-2.843c-.302.423-.847.605-1.27.302-3.388-2.056-8.534-2.662-12.422-1.452-.423.181-.907-.06-.967-.484-.061-.424.182-.907.605-.968 4.459-1.33 10.086-.665 13.958 1.755.423.303.605.848.302 1.27v-.001zm.121-3.024c-3.903-2.42-10.406-2.601-14.42-1.452-.484.121-.968-.182-1.089-.665-.121-.484.182-.968.665-1.089C5.79 6.28 12.857 6.46 17.325 9.24c.484.303.726.848.423 1.27-.302.484-.847.727-1.27.424z"></path></svg>
                        <span>Spotify</span>
                    </button>
                </div>
                <div id="playlistMessagePlaceholder" class="h-6 mt-1"></div>
            </div>
            <div id="spotifyPlayerHost" class="mt-6 player-wrapper"> 
                 <p id="playerDefaultPlaceholder" class="text-center text-[#657153] italic absolute inset-0 flex items-center justify-center">Activa la m√∫sica y carga un enlace de Spotify para empezar.</p>
            </div>
        </section>

        <section id="ambientAudioVisualizerSection" class="bg-canvas p-6 rounded-xl soft-shadow artistic-border section-oil-effect text-center">
            <h2 class="font-artistic text-2xl text-timer mb-2 text-center">Visualizador Ambiental üé§</h2>
            <p class="text-[#657153] mb-1 text-sm">Reacciona al audio del sistema/micr√≥fono.</p>
            <button id="toggleAmbientVisualizerButton" class="btn-visualizer-action">Activar Visualizador</button>
            <canvas id="ambientAudioVisualizerCanvasVertical" class="mt-2"></canvas> 
            <div class="warning text-xs text-red-700 mt-1" id="ambientAudioWarning">Pide permiso al micr√≥fono o act√≠valo.</div>
            <form id="youtubeSearchForm" target="_blank" class="youtube-search-form mt-3">
                <input type="text" id="youtubeSearchInput" placeholder="Buscar en YouTube..." class="youtube-search-input">
                <button type="submit" class="youtube-search-button">Buscar</button>
            </form>
        </section>
        
        <section id="todoSection" class="bg-canvas p-6 rounded-xl soft-shadow artistic-border section-oil-effect">
            <h2 class="font-artistic text-2xl text-timer mb-4 text-center">Mis Tareas Pendientes üìù</h2>
            <div class="todo-input-group">
                <input type="text" id="todoInput" placeholder="A√±adir nueva tarea..." class="input-style p-2 rounded-lg flex-grow">
                <button id="addTodoButton" class="btn-active px-4 py-2 rounded-lg font-semibold">A√±adir</button>
            </div>
            <ul id="todoList" class="mt-4 space-y-2">
                </ul>
        </section>

        <section id="aiSection" class="bg-canvas p-6 rounded-xl soft-shadow artistic-border section-oil-effect">
            <h2 class="font-artistic text-2xl text-timer mb-6 text-center">Sugerencias Inteligentes ‚ú®</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-[#657153] mb-1">Elige un modo:</label>
                <div class="flex space-x-2">
                    <button id="aiModeStudy" class="ai-mode-button flex-1 py-2 px-4 rounded-lg text-sm">Estudio üìò</button>
                    <button id="aiModeCreativity" class="ai-mode-button flex-1 py-2 px-4 rounded-lg text-sm">Creatividad üé®</button>
                </div>
            </div>
            <div>
                <label for="aiQuestionInput" class="block text-sm font-medium text-[#657153] mb-1">Escribe tu pregunta o idea:</label>
                <textarea id="aiQuestionInput" rows="3" placeholder="Ej: ¬øC√≥mo resuelvo esta ecuaci√≥n? o ¬øQu√© colores combinan con el azul?" class="w-full p-3 rounded-lg input-style focus:outline-none focus:ring-2 focus:ring-[#9e683b]"></textarea>
            </div>
            <button id="getAiSuggestionButton" class="btn-active w-full py-2.5 px-4 rounded-lg font-semibold mt-4">Obtener Sugerencia</button>
            <div id="aiResponseContainer" class="mt-6 p-4 rounded-lg min-h-[50px] hidden whitespace-pre-wrap"></div>
            <div id="aiLoadingIndicator" class="text-center text-[#657153] italic mt-4 hidden">Pensando... üß†</div>
        </section>
    </main>

    <footer class="page-footer">
        <p>¬© 2024 PomOil. Todos los derechos reservados.</p>
        <p class="mt-1">Nota: Algunas funciones como el visualizador de audio ambiental o la reproducci√≥n de Spotify pueden variar su comportamiento dependiendo del navegador y la configuraci√≥n del dispositivo.</p>
    </footer>


    <div id="settingsModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content p-6 md:p-8 rounded-xl soft-shadow w-full max-w-md section-oil-effect">
            <h3 class="font-artistic text-2xl text-timer mb-6 text-center">Configuraci√≥n General</h3>
            <div class="space-y-4">
                <div><label for="workTimeInput" class="block text-sm font-medium text-[#657153] mb-1">Tiempo de Trabajo (minutos):</label><input type="number" id="workTimeInput" value="25" min="1" class="w-full p-2 rounded-lg input-style"></div>
                <div><label for="shortBreakInput" class="block text-sm font-medium text-[#657153] mb-1">Descanso Corto (minutos):</label><input type="number" id="shortBreakInput" value="5" min="1" class="w-full p-2 rounded-lg input-style"></div>
                <div><label for="longBreakInput" class="block text-sm font-medium text-[#657153] mb-1">Descanso Largo (minutos):</label><input type="number" id="longBreakInput" value="15" min="1" class="w-full p-2 rounded-lg input-style"></div>
                <div><label for="alarmSoundSelect" class="block text-sm font-medium text-[#657153] mb-1">Sonido de Alarma:</label><select id="alarmSoundSelect" class="w-full p-2 rounded-lg input-style"><option value="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">Reloj Despertador</option><option value="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg">Reloj Digital</option><option value="https://actions.google.com/sounds/v1/notifications/bell.ogg">Campana</option><option value="https://actions.google.com/sounds/v1/notifications/harp_notification.ogg">Arpa Suave</option></select></div>
            </div>
            <div id="settingsMessagePlaceholder" class="h-8 mt-3"></div>
            <div class="mt-6 flex justify-end space-x-3"><button id="cancelSettingsButton" class="btn-control px-4 py-2 rounded-lg">Cancelar</button><button id="saveSettingsButton" class="btn-active px-4 py-2 rounded-lg">Guardar</button></div>
        </div>
    </div>
    <div id="sessionEndModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content p-6 md:p-8 rounded-xl soft-shadow w-full max-w-sm text-center section-oil-effect">
            <h3 id="sessionEndTitle" class="font-artistic text-2xl text-timer mb-4">¬°Sesi√≥n Terminada!</h3>
            <p id="sessionEndMessage" class="text-main mb-6">¬øListo para la siguiente fase?</p>
            <button id="proceedNextPhaseButton" class="btn-active w-full py-2.5 px-4 rounded-lg font-semibold">Comenzar</button>
        </div>
    </div>
    <div id="imageModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden">
        <div class="relative"><img id="enlargedImageView" src="#" alt="Imagen de referencia ampliada"><button id="closeImageModalButton" title="Cerrar imagen">√ó</button></div>
    </div>
    <audio id="notificationSound" preload="auto"></audio>

    <script>
        // --- DOM Elements ---
        const timeDisplay = document.getElementById('timeDisplay'), timerProgress = document.getElementById('timerProgress');
        const startButton = document.getElementById('startButton'), pauseButton = document.getElementById('pauseButton'), resetButton = document.getElementById('resetButton');
        const settingsButton = document.getElementById('settingsButton'), currentModeDisplay = document.getElementById('currentModeDisplay');
        const notificationSound = document.getElementById('notificationSound');
        const musicToggleButton = document.getElementById('musicToggleButton'), musicToggleText = document.getElementById('musicToggleText'), musicIcon = document.getElementById('musicIcon');
        const playlistLinkInput = document.getElementById('playlistLinkInput'), loadPlaylistButton = document.getElementById('loadPlaylistButton');
        const spotifyPlayerHost = document.getElementById('spotifyPlayerHost'); 
        const playerDefaultPlaceholder = document.getElementById('playerDefaultPlaceholder');
        const playlistMessagePlaceholder = document.getElementById('playlistMessagePlaceholder');
        const spotifyLoginButton = document.getElementById('spotifyLoginButton'); 
        const settingsModal = document.getElementById('settingsModal'), workTimeInput = document.getElementById('workTimeInput');
        const shortBreakInput = document.getElementById('shortBreakInput'), longBreakInput = document.getElementById('longBreakInput');
        const alarmSoundSelect = document.getElementById('alarmSoundSelect'), saveSettingsButton = document.getElementById('saveSettingsButton');
        const cancelSettingsButton = document.getElementById('cancelSettingsButton'), settingsMessagePlaceholder = document.getElementById('settingsMessagePlaceholder');
        const sessionEndModal = document.getElementById('sessionEndModal'), sessionEndTitle = document.getElementById('sessionEndTitle');
        const sessionEndMessage = document.getElementById('sessionEndMessage'), proceedNextPhaseButton = document.getElementById('proceedNextPhaseButton');
        const aiModeStudyButton = document.getElementById('aiModeStudy'), aiModeCreativityButton = document.getElementById('aiModeCreativity');
        const aiQuestionInput = document.getElementById('aiQuestionInput'), getAiSuggestionButton = document.getElementById('getAiSuggestionButton');
        const aiResponseContainer = document.getElementById('aiResponseContainer'), aiLoadingIndicator = document.getElementById('aiLoadingIndicator');
        const imageUploadDropArea = document.getElementById('imageUploadDropArea');
        const imageUploadInput = document.getElementById('imageUploadInput'), uploadedImagePreview = document.getElementById('uploadedImagePreview');
        const imageUploadPlaceholder = document.getElementById('imageUploadPlaceholder'), imageControls = document.getElementById('imageControls');
        const enlargeImageButton = document.getElementById('enlargeImageButton'), removeImageButton = document.getElementById('removeImageButton');
        const imageModal = document.getElementById('imageModal'), enlargedImageView = document.getElementById('enlargedImageView'), closeImageModalButton = document.getElementById('closeImageModalButton');
        const ambientCanvasVertical = document.getElementById("ambientAudioVisualizerCanvasVertical");
        const ambientAudioWarning = document.getElementById("ambientAudioWarning");
        const toggleAmbientVisualizerButton = document.getElementById("toggleAmbientVisualizerButton");
        const youtubeSearchForm = document.getElementById("youtubeSearchForm"); 
        const youtubeSearchInput = document.getElementById("youtubeSearchInput"); 
        const todoInput = document.getElementById('todoInput');
        const addTodoButton = document.getElementById('addTodoButton');
        const todoList = document.getElementById('todoList');

        // --- App State & Config ---
        let workTime = 25 * 60, shortBreakTime = 5 * 60, longBreakTime = 15 * 60;
        let selectedAlarmSound = 'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg';
        let currentTime = workTime, timerInterval, isPaused = false, currentMode = 'work', pomodoroCount = 0;
        let musicEnabled = false;
        let spotifyPlayerIframe = null; 
        let currentAiMode = 'study';
        const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 45;
        let ambientAudioCtx, ambientAnalyser, ambientBufferLength, ambientDataArray;
        let ambientAnimationId = null;
        let isAmbientVisualizerActive = false;
        let mediaStreamSource = null;

        // --- Utility Functions ---
        function showTemporaryMessage(element, message, type = 'error', duration = 3000) { 
            element.textContent = message; element.className = `temporary-message message-${type}`; 
            setTimeout(() => { element.textContent = ''; element.className = ''; }, duration);
        }
        
        // --- Timer Logic ---
        function updateDisplay() {
            const minutes = Math.floor(currentTime / 60), seconds = currentTime % 60;
            timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            let totalDuration = currentMode === 'work' ? workTime : (currentMode === 'shortBreak' ? shortBreakTime : longBreakTime);
            const progress = totalDuration > 0 ? ((totalDuration - currentTime) / totalDuration) * CIRCLE_CIRCUMFERENCE : 0;
            timerProgress.style.strokeDashoffset = progress;
        }
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            isPaused = false;
            startButton.classList.add('hidden'); pauseButton.classList.remove('hidden');
            updateCurrentModeDisplay();
            if (musicEnabled && spotifyPlayerIframe && currentMode === 'work') sendSpotifyCommand('play');
            timerInterval = setInterval(() => {
                if (!isPaused && currentTime > 0) { currentTime--; updateDisplay(); } 
                else if (currentTime === 0) { clearInterval(timerInterval); handleSessionEnd(); }
            }, 1000);
        }
        function pauseTimer() {
            isPaused = true; clearInterval(timerInterval);
            pauseButton.classList.add('hidden'); startButton.classList.remove('hidden'); startButton.textContent = 'Reanudar';
            if (musicEnabled && spotifyPlayerIframe) sendSpotifyCommand('pause');
        }
        function resetTimer(mode = 'work', manualReset = true) {
            clearInterval(timerInterval); isPaused = false; currentMode = mode;
            if (manualReset) pomodoroCount = 0;
            currentTime = mode === 'work' ? workTime : (mode === 'shortBreak' ? shortBreakTime : longBreakTime);
            updateDisplay(); updateCurrentModeDisplay();
            startButton.classList.remove('hidden'); pauseButton.classList.add('hidden'); startButton.textContent = 'Iniciar';
            if (musicEnabled && spotifyPlayerIframe) sendSpotifyCommand(currentMode === 'work' ? 'play' : 'pause');
        }
        function updateCurrentModeDisplay() {
            let modeText = '';
            switch(currentMode) {
                case 'work': modeText = 'Sesi√≥n de Trabajo'; break;
                case 'shortBreak': modeText = 'Descanso Corto'; break;
                case 'longBreak': modeText = 'Descanso Largo'; break;
            }
            currentModeDisplay.textContent = modeText;
        }
        function handleSessionEnd() {
            playNotificationSound();
            let title = '', message = '', buttonText = '';
            if (currentMode === 'work') {
                title = '¬°Trabajo Terminado!'; pomodoroCount++;
                message = pomodoroCount % 4 === 0 ? '¬°Excelente! Es hora de un merecido descanso largo.' : 'Buen trabajo. Toma un descanso corto.';
                buttonText = pomodoroCount % 4 === 0 ? 'Iniciar Descanso Largo' : 'Iniciar Descanso Corto';
            } else {
                title = currentMode === 'shortBreak' ? '¬°Descanso Corto Finalizado!' : '¬°Descanso Largo Finalizado!';
                message = '¬øListo para la siguiente fase?'; buttonText = 'Iniciar Trabajo';
            }
            sessionEndTitle.textContent = title; sessionEndMessage.textContent = message;
            proceedNextPhaseButton.textContent = buttonText; sessionEndModal.classList.remove('hidden');
        }
        proceedNextPhaseButton.addEventListener('click', () => {
            sessionEndModal.classList.add('hidden'); switchToNextMode();
        });
        function switchToNextMode() {
            currentMode = currentMode === 'work' ? (pomodoroCount % 4 === 0 ? 'longBreak' : 'shortBreak') : 'work';
            resetTimer(currentMode, false); startTimer(); 
        }
        function playNotificationSound() {
            notificationSound.src = selectedAlarmSound; notificationSound.currentTime = 0; 
            notificationSound.play().catch(error => console.warn("Error al reproducir sonido:", error));
        }

        // --- Settings Logic ---
        settingsButton.addEventListener('click', () => {
            workTimeInput.value = workTime / 60; shortBreakInput.value = shortBreakTime / 60;
            longBreakInput.value = longBreakTime / 60; alarmSoundSelect.value = selectedAlarmSound;
            settingsModal.classList.remove('hidden');
        });
        cancelSettingsButton.addEventListener('click', () => {
            settingsModal.classList.add('hidden'); settingsMessagePlaceholder.textContent = ''; 
        });
        saveSettingsButton.addEventListener('click', () => {
            const newWorkTime = parseInt(workTimeInput.value), newShortBreak = parseInt(shortBreakInput.value), newLongBreak = parseInt(longBreakInput.value);
            if (newWorkTime > 0 && newShortBreak > 0 && newLongBreak > 0) {
                workTime = newWorkTime * 60; shortBreakTime = newShortBreak * 60; longBreakTime = newLongBreak * 60;
                selectedAlarmSound = alarmSoundSelect.value;
                settingsModal.classList.add('hidden'); resetTimer(currentMode, false); 
                showTemporaryMessage(settingsMessagePlaceholder, 'Configuraci√≥n guardada.', 'success');
            } else {
                showTemporaryMessage(settingsMessagePlaceholder, 'Valores de tiempo no v√°lidos.', 'error');
            }
        });

        // --- Soundtrack Logic (Spotify Compacto) ---
        musicToggleButton.addEventListener('click', () => {
            musicEnabled = !musicEnabled;
            musicToggleText.textContent = musicEnabled ? 'Desactivar M√∫sica' : 'Activar M√∫sica';
            if (musicEnabled) {
                musicIcon.innerHTML = `<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle><line x1="9" y1="8" x2="18" y2="6"></line>`;
                if (spotifyPlayerIframe && currentMode === 'work' && !isPaused) sendSpotifyCommand('play');
                playerDefaultPlaceholder.classList.toggle('hidden', !!spotifyPlayerIframe);
            } else {
                musicIcon.innerHTML = `<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle><line x1="1" y1="1" x2="23" y2="23"></line>`;
                if (spotifyPlayerIframe) sendSpotifyCommand('pause');
                if (!spotifyPlayerIframe) playerDefaultPlaceholder.classList.remove('hidden');
            }
        });
        
        if(spotifyLoginButton) {
            spotifyLoginButton.addEventListener('click', () => {
                window.open('https://accounts.spotify.com/login', '_blank');
            });
        }

        loadPlaylistButton.addEventListener('click', () => {
            const link = playlistLinkInput.value.trim();
            if (!link) {
                showTemporaryMessage(playlistMessagePlaceholder, 'Por favor, pega un enlace de Spotify.', 'error'); return;
            }
            spotifyPlayerHost.innerHTML = ''; 
            playerDefaultPlaceholder.classList.add('hidden'); 
            spotifyPlayerIframe = null;

            const spotifyRegex = /https?:\/\/open\.spotify\.com\/(playlist|track|album|artist)\/([a-zA-Z0-9]+)/;
            const spotifyMatch = link.match(spotifyRegex);

            if (spotifyMatch && spotifyMatch[1] && spotifyMatch[2]) {
                const type = spotifyMatch[1];
                const id = spotifyMatch[2];
                const embedUrl = `https://open.spotify.com/embed/${type}/${id}?utm_source=generator&theme=0`; 
                spotifyPlayerHost.className = `mt-6 player-wrapper`; 
                loadSpotifyPlayer(embedUrl);
                playlistLinkInput.value = '';
            } else {
                showTemporaryMessage(playlistMessagePlaceholder, 'Enlace de Spotify no reconocido o no v√°lido.', 'error', 4000);
                spotifyPlayerHost.innerHTML = ''; 
                const newPlaceholder = playerDefaultPlaceholder.cloneNode(true);
                spotifyPlayerHost.appendChild(newPlaceholder);
                newPlaceholder.classList.remove('hidden');
            }
        });
        function loadSpotifyPlayer(embedUrl) {
            spotifyPlayerIframe = document.createElement('iframe');
            spotifyPlayerIframe.src = embedUrl;
            spotifyPlayerIframe.width="100%"; 
            spotifyPlayerIframe.height="80"; 
            spotifyPlayerIframe.frameBorder="0";
            spotifyPlayerIframe.allowFullscreen="";
            spotifyPlayerIframe.allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
            spotifyPlayerIframe.loading="lazy";
            spotifyPlayerHost.appendChild(spotifyPlayerIframe); 
            spotifyPlayerIframe.onload = () => {
                if (musicEnabled && currentMode === 'work' && !isPaused) sendSpotifyCommand('play');
            };
            showTemporaryMessage(playlistMessagePlaceholder, 'M√∫sica de Spotify cargada.', 'success');
        }
        function sendSpotifyCommand(command) {
            if (!spotifyPlayerIframe || !spotifyPlayerIframe.contentWindow) return;
            const message = JSON.stringify({ command: command });
            spotifyPlayerIframe.contentWindow.postMessage(message, 'https://open.spotify.com/embed/');
        }


        // --- AI Logic ---
        aiModeStudyButton.addEventListener('click', () => {
            currentAiMode = 'study';
            aiModeStudyButton.classList.add('active');
            aiModeCreativityButton.classList.remove('active');
            aiResponseContainer.className = 'mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap ai-response-study';
            if (!aiResponseContainer.classList.contains('hidden')) aiResponseContainer.classList.add('hidden'); 
        });
        aiModeCreativityButton.addEventListener('click', () => {
            currentAiMode = 'creativity';
            aiModeCreativityButton.classList.add('active');
            aiModeStudyButton.classList.remove('active');
            aiResponseContainer.className = 'mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap ai-response-creativity';
            if (!aiResponseContainer.classList.contains('hidden')) aiResponseContainer.classList.add('hidden');
        });
        getAiSuggestionButton.addEventListener('click', async () => {
            const question = aiQuestionInput.value.trim();
            if (!question) {
                aiResponseContainer.textContent = 'Por favor, escribe una pregunta o idea.';
                aiResponseContainer.className = `mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap message-error`;
                aiResponseContainer.classList.remove('hidden');
                return;
            }
            aiLoadingIndicator.classList.remove('hidden');
            aiResponseContainer.classList.add('hidden');
            getAiSuggestionButton.disabled = true;
            let prompt = currentAiMode === 'study' ? 
                `Eres un tutor acad√©mico experto y amigable. Ayuda al estudiante con la siguiente pregunta de manera clara, concisa y educativa. Si es un problema matem√°tico, muestra los pasos si es posible:\n\n"${question}"` :
                `Eres un asistente creativo, inspirador y entusiasta. Ofrece ideas originales y sugerencias √∫tiles para la siguiente petici√≥n o idea. Anima al usuario a explorar su creatividad:\n\n"${question}"`;
            try {
                const apiKey = "AIzaSyCSSfVuLqCyrQIRZqWGULr8BxoMmLLY4OY"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json(); throw new Error(`Error de la API: ${errorData.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    aiResponseContainer.textContent = result.candidates[0].content.parts[0].text;
                    aiResponseContainer.className = `mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap ${currentAiMode === 'study' ? 'ai-response-study' : 'ai-response-creativity'}`;
                } else {
                    aiResponseContainer.textContent = 'No se pudo obtener una respuesta con el formato esperado.';
                    aiResponseContainer.className = `mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap message-error`;
                }
            } catch (error) {
                console.error("Error al obtener sugerencia de IA:", error);
                aiResponseContainer.textContent = `Error: ${error.message}. Intenta de nuevo m√°s tarde.`;
                aiResponseContainer.className = `mt-6 p-4 rounded-lg min-h-[50px] whitespace-pre-wrap message-error`;
            } finally {
                aiLoadingIndicator.classList.add('hidden');
                aiResponseContainer.classList.remove('hidden');
                getAiSuggestionButton.disabled = false;
            }
        });

        // --- Visual Reference Logic con Drag & Drop ---
        function handleImageFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImagePreview.src = e.target.result;
                    uploadedImagePreview.classList.remove('hidden');
                    imageUploadPlaceholder.classList.add('hidden');
                    imageControls.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                showTemporaryMessage(imageUploadDropArea, "Por favor, selecciona o arrastra un archivo de imagen.", 'error');
                removeUploadedImageFull();
            }
        }
        imageUploadInput.addEventListener('change', function(event) {
            handleImageFile(event.target.files[0]);
        });
        imageUploadDropArea.addEventListener('click', () => imageUploadInput.click()); 
        imageUploadDropArea.addEventListener('dragover', (event) => {
            event.preventDefault(); 
            imageUploadDropArea.classList.add('dragover');
        });
        imageUploadDropArea.addEventListener('dragleave', () => {
            imageUploadDropArea.classList.remove('dragover');
        });
        imageUploadDropArea.addEventListener('drop', (event) => {
            event.preventDefault();
            imageUploadDropArea.classList.remove('dragover');
            if (event.dataTransfer.items) {
                if (event.dataTransfer.items[0].kind === 'file') {
                    const file = event.dataTransfer.items[0].getAsFile();
                    handleImageFile(file);
                }
            } else { 
                const file = event.dataTransfer.files[0];
                handleImageFile(file);
            }
        });
        enlargeImageButton.addEventListener('click', function() { 
            if (uploadedImagePreview.src && uploadedImagePreview.src !== '#') {
                enlargedImageView.src = uploadedImagePreview.src;
                imageModal.classList.remove('hidden');
            }
        });
        closeImageModalButton.addEventListener('click', function() { 
            imageModal.classList.add('hidden');
            enlargedImageView.src = '#';
        });
        removeImageButton.addEventListener('click', removeUploadedImageFull); 
        function removeUploadedImageFull() { 
            uploadedImagePreview.src = '#';
            uploadedImagePreview.classList.add('hidden');
            imageUploadPlaceholder.classList.remove('hidden');
            imageControls.classList.add('hidden');
            imageUploadInput.value = null;
        }


        // --- Ambient Audio Visualizer Logic (Vertical, con buscador YouTube) ---
        if (ambientCanvasVertical && ambientAudioWarning && toggleAmbientVisualizerButton) {
            const ambientCtxVertical = ambientCanvasVertical.getContext("2d");

            async function startAmbientVisualizationVertical() {
                if (isAmbientVisualizerActive) return;
                try {
                    if (ambientAudioCtx && ambientAudioCtx.state === 'suspended') { await ambientAudioCtx.resume(); }
                    else if (!ambientAudioCtx || ambientAudioCtx.state === 'closed') { ambientAudioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
                    
                    ambientAnalyser = ambientAudioCtx.createAnalyser();
                    ambientAnalyser.fftSize = 128; 
                    ambientBufferLength = ambientAnalyser.frequencyBinCount; 
                    ambientDataArray = new Uint8Array(ambientBufferLength);

                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    mediaStreamSource = ambientAudioCtx.createMediaStreamSource(stream);
                    mediaStreamSource.connect(ambientAnalyser);
                    
                    ambientAudioWarning.textContent = 'Visualizador activo. Escuchando...';
                    ambientAudioWarning.className = 'warning text-xs text-green-700 mt-1';
                    isAmbientVisualizerActive = true;
                    toggleAmbientVisualizerButton.textContent = "Desactivar Visualizador";
                    if (ambientAnimationId) cancelAnimationFrame(ambientAnimationId);
                    drawAmbientVisualizerVertical();
                } catch (err) {
                    ambientAudioWarning.textContent = 'Error al acceder al micr√≥fono. Revisa los permisos.';
                    ambientAudioWarning.className = 'warning text-xs text-red-700 mt-1';
                    console.error('Error accediendo al micr√≥fono:', err);
                    isAmbientVisualizerActive = false;
                    toggleAmbientVisualizerButton.textContent = "Activar Visualizador";
                    if(ambientCtxVertical) ambientCtxVertical.clearRect(0, 0, ambientCanvasVertical.width, ambientCanvasVertical.height);
                }
            }

            function stopAmbientVisualizationVertical() {
                if (!isAmbientVisualizerActive) return;
                if (ambientAnimationId) { cancelAnimationFrame(ambientAnimationId); ambientAnimationId = null; }
                if (mediaStreamSource) {
                    mediaStreamSource.disconnect();
                    mediaStreamSource.mediaStream.getTracks().forEach(track => track.stop());
                    mediaStreamSource = null;
                }
                ambientAudioWarning.textContent = 'Visualizador desactivado.';
                ambientAudioWarning.className = 'warning text-xs text-[#8c6f56] mt-1';
                isAmbientVisualizerActive = false;
                toggleAmbientVisualizerButton.textContent = "Activar Visualizador";
                if(ambientCtxVertical) ambientCtxVertical.clearRect(0, 0, ambientCanvasVertical.width, ambientCanvasVertical.height);
            }

            toggleAmbientVisualizerButton.addEventListener('click', () => {
                if (isAmbientVisualizerActive) stopAmbientVisualizationVertical();
                else startAmbientVisualizationVertical();
            });

            function drawAmbientVisualizerVertical() {
                if (!isAmbientVisualizerActive || !ambientAnalyser || !ambientAudioCtx || ambientAudioCtx.state === 'closed') {
                    if (ambientAnimationId) { cancelAnimationFrame(ambientAnimationId); ambientAnimationId = null; }
                    return;
                }
                ambientAnimationId = requestAnimationFrame(drawAmbientVisualizerVertical);
                ambientAnalyser.getByteFrequencyData(ambientDataArray);

                const canvasWidth = ambientCanvasVertical.width;
                const canvasHeight = ambientCanvasVertical.height;
                ambientCtxVertical.clearRect(0, 0, canvasWidth, canvasHeight);

                const barWidth = canvasWidth / ambientBufferLength; 
                let x = 0;

                for (let i = 0; i < ambientBufferLength; i++) {
                    const barHeight = (ambientDataArray[i] / 255) * canvasHeight; 

                    const gradient = ambientCtxVertical.createLinearGradient(x, canvasHeight, x, canvasHeight - barHeight);
                    gradient.addColorStop(0, `rgba(100, 180, 255, 0.6)`); 
                    gradient.addColorStop(0.5, `rgba(80, 220, 180, 0.7)`); 
                    gradient.addColorStop(1, `rgba(120, 255, 220, 0.8)`); 
                    ambientCtxVertical.fillStyle = gradient;

                    ambientCtxVertical.fillRect(x, canvasHeight - barHeight, barWidth -1 , barHeight); 
                    x += barWidth;
                }
            }
            
            if (youtubeSearchForm) {
                youtubeSearchForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    const query = youtubeSearchInput.value.trim();
                    if (query) {
                        const url = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
                        window.open(url, '_blank');
                    }
                });
            }
        }
        
        // --- To-Do List Logic ---
        if (addTodoButton && todoInput && todoList) {
            addTodoButton.addEventListener('click', addTodo);
            todoInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTodo();
                }
            });

            function addTodo() {
                const taskText = todoInput.value.trim();
                if (taskText === '') {
                    showTemporaryMessage(todoList.parentElement, "La tarea no puede estar vac√≠a.", 'error', 2000);
                    return;
                }

                const listItem = document.createElement('li');
                listItem.className = 'todo-item flex items-center justify-between p-3 bg-[#fbf3eb] border border-[#e0d8d0] rounded-md cursor-pointer hover:bg-[#f5e9dd]';
                
                const taskSpan = document.createElement('span');
                taskSpan.textContent = taskText;
                taskSpan.className = "flex-grow";

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '√ó'; 
                deleteButton.className = 'delete-todo text-[#c28f52] hover:text-[#9e683b] text-xl font-bold ml-2';
                deleteButton.title = "Eliminar tarea";

                listItem.appendChild(taskSpan);
                listItem.appendChild(deleteButton);
                todoList.appendChild(listItem);

                listItem.addEventListener('click', function(e) {
                    if (e.target !== deleteButton && !deleteButton.contains(e.target)) { 
                        listItem.classList.toggle('completed');
                        taskSpan.classList.toggle('line-through');
                        taskSpan.classList.toggle('text-[#8c6f56]');
                    }
                });

                deleteButton.addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    todoList.removeChild(listItem);
                });

                todoInput.value = ''; 
            }
        }


        // --- App Initialization ---
        function initializeApp() {
            notificationSound.src = selectedAlarmSound; 
            timerProgress.style.strokeDasharray = CIRCLE_CIRCUMFERENCE;
            timerProgress.style.strokeDashoffset = 0; 
            updateDisplay();
            updateCurrentModeDisplay();
            aiModeStudyButton.click(); 
            
            spotifyPlayerHost.innerHTML = ''; 
            const newPlaceholder = playerDefaultPlaceholder.cloneNode(true); 
            spotifyPlayerHost.appendChild(newPlaceholder); 
            newPlaceholder.classList.remove('hidden');

            if(ambientAudioWarning) ambientAudioWarning.textContent = 'Visualizador desactivado. Haz clic en "Activar Visualizador".';
            if (ambientCanvasVertical) {
                ambientCanvasVertical.width = ambientCanvasVertical.offsetWidth;
                ambientCanvasVertical.height = 150; 
            }
        }
        
        window.addEventListener('resize', () => {
            if (ambientCanvasVertical && isAmbientVisualizerActive) { 
                ambientCanvasVertical.width = ambientCanvasVertical.offsetWidth;
            } else if (ambientCanvasVertical) { 
                 ambientCanvasVertical.width = ambientCanvasVertical.offsetWidth;
            }
        });

        initializeApp();
    </script>
</body>
</html>
